# Supabase SQL Query for RFID Events Table

```sql
-- Enable Row Level Security
CREATE TABLE rfid_events (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL,
    event_type TEXT NOT NULL CHECK (event_type IN ('tag_insert', 'tag_removed')),
    tag_present BOOLEAN NOT NULL,
    tag_id TEXT NOT NULL,
    tag_type TEXT,
    wifi_status TEXT,
    time_status TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes
CREATE INDEX idx_rfid_events_timestamp ON rfid_events(timestamp);
CREATE INDEX idx_rfid_events_tag_id ON rfid_events(tag_id);
CREATE INDEX idx_rfid_events_event_type ON rfid_events(event_type);

-- Enable Row Level Security (RLS)
ALTER TABLE rfid_events ENABLE ROW LEVEL SECURITY;

-- Create policy to allow inserts from webhook
CREATE POLICY "Enable insert for webhooks" ON rfid_events
    FOR INSERT
    TO authenticated
    WITH CHECK (true);

-- Create policy to allow read access
CREATE POLICY "Enable read access for authenticated users" ON rfid_events
    FOR SELECT
    TO authenticated
    USING (true);

-- Function to automatically update updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Trigger to call the function
CREATE TRIGGER update_rfid_events_updated_at
    BEFORE UPDATE ON rfid_events
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Example insert that would work with our webhook payload
INSERT INTO rfid_events (
    timestamp,
    event_type,
    tag_present,
    tag_id,
    tag_type,
    wifi_status,
    time_status
) VALUES (
    '2024-02-24 12:53:04+01',  -- From payload timestamp
    'tag_insert',              -- From payload event_type
    true,                      -- From payload tag_present
    'dd 54 2a 83',            -- From payload tag_id
    'Mifare Classic (4-byte)', -- From payload tag_type
    'Connected to WiFi-2.4-6B2E (-49 dBm)', -- From payload wifi_status
    'Synced with NTP'         -- From payload time_status
);
```

## Notes

- Uses Supabase/PostgreSQL specific types (TIMESTAMPTZ, BIGINT for id)
- Includes Row Level Security (RLS) policies for secure access
- Automatic timestamp handling for created_at and updated_at
- Compatible with Supabase's authentication system
- Indexes for efficient querying
- CHECK constraint ensures valid event_types

## n8n Integration with Service Role Key

1. Get Supabase Service Role Key:
   - Go to your Supabase project dashboard
   - Navigate to Project Settings -> API
   - Copy the `service_role` key (starts with `eyJ...`)
   - This key bypasses RLS and has full access to the database

2. Configure n8n Workflow:

   ```txt
   Webhook Node -> Supabase Node
   ```

3. Supabase Node Configuration:
   - Add new credentials
     - Host: Your Supabase project URL (e.g., `https://xxxxxxxxxxxx.supabase.co`)
     - Service Role Key: Paste the key from step 1
     - Name these credentials (e.g., "RFID-Supabase")
   - Operation: Insert
   - Table: rfid_events
   - Data Mapping (from webhook payload):

     ```txt
     {
       "timestamp": "{{$json.rfid_poll_result.timestamp}}",
       "event_type": "{{$json.rfid_poll_result.event_type}}",
       "tag_present": "{{$json.rfid_poll_result.tag_present}}",
       "tag_id": "{{$json.rfid_poll_result.tag_id}}",
       "tag_type": "{{$json.rfid_poll_result.tag_type}}",
       "wifi_status": "{{$json.rfid_poll_result.wifi_status}}",
       "time_status": "{{$json.rfid_poll_result.time_status}}"
     }
     ```

Note: Since we're using the Service Role Key, the RLS policies in the SQL are not enforced for this connection. They remain useful for other access methods (like from the Supabase dashboard or client applications).
